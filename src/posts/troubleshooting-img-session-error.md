## 사이트 환경 업그레이드 후기

최근 회사에서 운영 중인 사이트의 환경 업그레이드를 진행하면서, 흥미로운 오류를 경험하게 되어 공유합니다.

## 업그레이드 환경

- **JDK**: 1.7 → 1.8
- **Apache**: 2.4
- **Tomcat**: 7 → 8

자바 버전 업그레이드에 맞춰 톰캣도 함께 8 버전으로 올렸습니다.

## 문제 발생

충분한 기간을 두고 검수까지 마친 뒤 운영에 반영했지만, 특이하게도 사이트 내 특정 **이미지(img) 호출 시 세션(Session) 관련 에러**가 발생했습니다.

## 원인 분석

문제는 JDK 업그레이드가 아니라 **Tomcat 7 → Tomcat 8 전환 과정**에서 비롯되었습니다.

스프링은 기본적으로 다음과 같은 흐름으로 동작합니다:

```
URL 요청 → Spring Security Filter Chain → Spring MVC
```

이 과정에서 **Spring MVC의 FlashMap 클래스**가 Redirect 시 데이터 전달(PRG 패턴 지원)을 위해 Session을 참조하게 되는데, 이때 세션 상태와 맞물려 오류가 발생한 것입니다.

## 왜 Tomcat 7에서는 발생하지 않았을까?

- **Tomcat 7**: Session을 `invalidate()`한 후 참조하면 `null` 혹은 빈 값 반환
- **Tomcat 8**: 동일한 상황에서 `IllegalStateException`을 발생

즉, Tomcat 8은 세션 처리에 훨씬 민감하게 반응하며, 이 예외가 서버에 잡혀 에러 로그로 남게 된 것입니다.

(참고로 Tomcat 7에서도 발생할 수 있으나 빈도가 낮습니다.)

## 테스트 과정에서 잡히지 못한 이유

FlashMap의 동작과 세션 상태가 특정 타이밍에만 충돌하는 케이스였기 때문에, 테스트 환경에서는 재현되지 않았습니다. 실제 운영 모니터링 중 단 한 번 발생한 사례이며, 재발 여부는 추후 모니터링 예정입니다.

## 조치 방안

### 1. Spring Security 예외 처리 적용

- 문제가 된 이미지 요청 경로를 Security 예외 처리 경로에 등록합니다.
- 이렇게 하면 해당 요청은 Security Filter Chain 및 Spring MVC 로직을 타지 않게 되어 FlashMap 참조 문제를 회피할 수 있습니다.

### 2. 로그 레벨 조정

- 본 오류는 운영 서비스 동작에 직접적인 영향을 주지 않습니다.
  (이미지 로딩 실패나 에러 페이지 리다이렉트가 발생하지 않음)
- 필요하다면 민감한 예외 로그만 제거하여 운영 환경의 불필요한 알람을 줄일 수 있습니다.

## 결론

Tomcat 버전 차이로 인해 **세션 처리 방식이 미묘하게 달라진 점**이 문제의 핵심이었습니다.

크리티컬한 이슈는 아니었지만, 환경 업그레이드 시 **세션 처리 방식과 프레임워크 내부 동작까지 꼼꼼히 확인해야 한다는 교훈**을 얻을 수 있었습니다.

