## JDK 업그레이드 기록 (1.7 -> 1.8)

**Java 버전**: 1.7 -> 1.8

**Tomcat**: tomcat 7.0.78 -> 8.5.0

**Server 환경**: dev - 온프로미스, prd - NCP, 윈도우 서버 2019

**기간**: 두달

**원인**: 사용하고 있는 외부 API 중 하나의 보안 업데이트

## 1. 사전 준비(local)

자바 버전 업데이트를 위해서 우선 로컬 환경부터 설정을 시작한다. 로컬 환경의 설정상에 있는 자바 버전을 업데이트 하여 실행 후 빌드하였고, 관련하여 충돌이 나는 부분 혹은 문제가 나는 부분을 찾는다. 프로젝트에서 사용 중인 외부 API와의 소통은 검증 혹은 운영에 배포하기 전에는 확인이 불가능했기에, 그 이외 로직 등에 대해서만 점검했다.

### 확인점

1. **자바 dependency는 잘 동작하는가**
   - 자바에서 dependency로 끌어오는 라이브러리 중에서 문제가 생길 부분이 있을 수 있으니 꼼꼼히 기능을 확인했다. Spring security, Spring web 등 다양한 라이브러리의 기능을 전부 확인했다.

2. **톰캣 버전이 변경됨에 따라 달라지는 부분은 없는지**
   - 자바 버전 업데이트에 더해 톰캣 버전 업데이트 역시 진행되어야 했기에, 로컬 환경상에 프로젝트를 구동하던 톰캣을 변경하여 테스트했다.

3. **소스 상에서 변경되는 부분은 없는지**
   - 자바 7과 자바 8은 많은 부분이 변경된다. 대표적으로 자바 8에서는 stream이 사용되고, 자바 7에서는 사용되지 않는다. 이런 차이점이 수많은 소스들이 들어있는 프로젝트에서 오류를 부를 수 있기에 전부 확인했다.

### 특이사항

1. JDK 1.8로 Java 7로 빌드한 파일을 구동할 경우, 당연히 구동이 된다. JDK 1.8은 Java 7버전을 호환한다. Java 8로 빌드한 파일을 JDK 1.7로 구동할 경우는 동작이 안되지만, JDK 1.8로 Java 7로 빌드한 파일을 구동할 경우 문제없이 동작한다.

## 2. 검증 환경단 작업

이 모든 작업은 운영 환경단에 실제 작업을 하는 방식으로 테스트했다. 자바 7 -> 자바 8로의 변경 작업은 어떠한 문제점을 불러올지 완벽하게 예측할 수 없기에 신규 도메인을 따서 그 도메인을 테스트 후 작업을 진행하는 방향으로 작업 진로를 잡았다.

### 작업 방안(dev)

1. Tomcat 8, JDK 1.8 세팅
2. dev 도메인 신규 생성 및 Apache 신규 생성
3. 기존 포트와는 다른 신규 포트에 Tomcat 8을 매칭하고, 이를 이동시켜주는 신규 Apache를 생성
4. 프로젝트 폴더 신규 생성 및 JDK 1.8용 세팅

이렇게 하여 기존의 JDK 1.7 도메인, JDK 1.8 도메인 이렇게 두 가지 도메인을 동시에 운용하여 테스트를 진행한다. 이 모든 과정은 운영에 똑같이 반영될 예정이다.

### 실제 작업 진행 과정 및 특이사항

#### 1. Tomcat 8, JDK 1.8 세팅

- **DB 연결이 되지 않는 문제점이 발생했다.**
  - **해결방안**: ojdbc 7 버전을 사용하고 있는 부분이 문제라고 판단했다. 이 부분을 ojdbc 8로 수정하여 빌드했고, 이에 성공했다.

- **확인사항**
  - JDK 1.8은 JDK 1.7로 빌드한 파일이 구동되어야 한다. 프로젝트는 class 파일 형태로 배포되어 있었기에 JDK 1.8로 빌드한 class 파일을 일부만 넣어 구동시켜 보았다. 구동 결과 이상 없음 확인했다.
  - JDK 1.8, Tomcat 8로 서비스 구동 테스트. 위의 경우와 마찬가지로 Java 7로 빌드한 파일을 일부로 구동시켜 테스트했다.

#### 2. 실행 및 테스트

- 구동 완료 후 테스트 진행했다. 기존에 사용했던 모든 외부, 내부 API 테스트 및 모든 동작에 집중하여 테스트를 진행했다.

#### 3. 테스트 결과 및 수정점

- Java 7과 Java 8은 소스 상의 민감도가 다르다고 판단했다. 기존에 잘못 세팅되어서 이상한 파라미터로 넘기던 파일들이 존재했는데, Java 8로 빌드하여 넘기자 그 데이터들이 MyBatis 로직을 타고 DB에 인입되어 문제가 발생했다. 그 부분은 데이터를 보고 수정하여 완료했다.

## 3. 작업 방안 (prd_test)

prd에는 많은 작업이 들어간다. 운영 서버는 이중화가 되어 있기에 세션 클러스터링 관련 설정도 들어가야 하고, 온프로미스 환경인 dev와 다르게 NCP 환경이 점도 큰 차이라고 볼 수 있다.

### 작업 방안 (prd_test)

1. **NCP LoadBalancer Rule 변경**
   - 운영 환경 상의 사이트에 신규 도메인을 생성하고 이를 Apache에 연결되도록 LoadBalancer의 Rule을 변경한다.

2. **Apache Listen 포트, Tomcat Http1.1 포트, AJP 포트, Shutdown 포트 등 모든 포트를 신규로 생성한다.** (기존의 운영 파일에 영향이 가선 안된다.)

3. **Session Cluster 포트 신규 지정 및 생성**
   - 기존의 운영 사이트와 다른 세션 클러스터 포트를 신규 지정하고 생성한다. 공유하는 키 아이디 역시 신규로 생성한다.

4. **서비스 도메인 신규 생성 및 배포**
   - 테스트용 도메인을 신규로 생성하고 배포한다. 운영 환경인 만큼 외부에서도 접근이 가능하도록 설정했다.

5. **신규 Apache 서비스 등록**
   - 신규 Apache 서비스를 등록한다.

6. **Java 신규 설치 및 세팅**
   - 자바를 신규로 설치하고 인증서를 전부 신규로 재세팅한다.

프로젝트가 불행히도 톰캣 서버 상에 설정되어 있는 여러 설정이 존재하기에 톰캣 폴더의 설정파일은 전부 기존의 톰캣을 복사하여 사용하기로 결정했다. 또한 이중화 되어 있는 현재 사이트와 달리 테스트 사이트는 한개이기에 세션 클러스터링 부분을 추가했고, NCP, 온프로미스 환경 및 최대한 테스트와 맞추려고 노력했지만 조금 다른 부분이 있어 새로운 작업이 들어간다.

### 실제 작업 과정 및 특이사항

#### 1. Java 8, Apache, Tomcat 8 신규 설치

Java는 새로 설치할 경우, 재기동을 요구하는 경우가 있다. 실제 운영 중인 서비스이기에 재기동은 큰 영향을 줄 수 있다. 그렇기에 사용 시간이 가장 적은 시간대를 적어서 작업 일자를 잡았고 작업에는 대략 5분이 소요되었다.

#### 2. Tomcat, Apache 설정 변경

위에 했던 거처럼 포트, 서비스 홈 루트 등을 전부 변경했다.

#### 3. 서비스 홈 루트 신규 생성

소스 파일들이 존재하는 폴더 역시 신규 생성하여 테스트 도메인과 연결시킨다. JDK 1.8용 테스트 폴더를 신규로 생성한다. 로그 폴더 역시 신규로 생성한다.

#### 4. 구동 및 특이사항

dev 환경에서 작업을 진행하고 특이사항을 점검했음에도 특이점이 발생했다. 주로 Tomcat에서 특이점이 발생했다.

**톰캣 특이점**

Tomcat 7의 설정 파일을 그대로 사용하기 위해, 톰캣의 설정은 그대로 가져왔다. 이와 관련하여 특이점이 2가지 발생했다.

1. **MessageDispatcher15Interceptor 사용 중지**
   - 해당 클래스는 톰캣 7버전까지만 사용한다. 그 이후 버전은 사용하지 않기에 제거한다.

2. **JvmRouteSessionDBBinderListener 사용 X**
   - 해당 클래스는 Tomcat 8.5이상 버전에서는 사용하지 않는다.

두 가지 오류를 해결하고 프로젝트를 구동했다.

#### 5. 구동 및 테스트

실제 구동 및 테스트 과정에서는 특이사항이 발생하지 않았다.

## 4. 적용 방안 (prd)

실제 운영에 적용할 차례이다. 기존에 모든 부분들은 구동되었기에 따로 특이점은 없지만, 도메인을 신규로 따서 테스트한 작업을 거친 만큼 다른 작업들이 추가로 들어간다.

### 적용 방안 (prd)

**사전 작업:**

1. **JDK 1.8 빌드 파일로 구성된 프로젝트 준비**, 기존에 운영하던 테스트 사이트 도메인 삭제

2. **포트 및 파일 경로 변경 계획 수립**
   - 기존에 사용하던 운영 사이트의 경로에 신규 Tomcat 및 Java의 신규 버전이 적용되도록 모두 변경해서 Tomcat 폴더를 세팅해둔다. Session Cluster 포트, Apache 수신 포트, 톰캣 포트 및 프로젝트 구동 경로, 로그 경로 등 모든 부분을 기존의 운영과 맞게 적용되도록 톰캣 폴더를 미리 정해둔다.

### 운영 반영

1. **JDK 1.8로 세팅된 프로젝트로 폴더 변경**
   - 테스트 과정에서 사용했던 JDK 1.8 프로젝트 폴더의 이름 자체를 변경하여 기존의 프로젝트 운영 폴더에 맞춘다.

2. **NCP 로드밸런서 기능을 사용하여 실제 운영 사이트의 다운 시간이 최소화되도록 운영 반영**
   - 1번 서버와 2번 서버가 존재한다면, 로드밸런서 잠시 작업용으로 세팅하여 작업하는 서버와 반대되는 서버에 맞추어 작업을 진행한다. 이렇게 함으로써 서버 다운타임을 최소화하는 방식으로 작업을 진행한다.

## 5. 결론

모든 작업은 정상 진행되어 JDK 1.7 -> 1.8로 변경하는 작업 완료했다. 이제 Java 개발자로써 1.8의 기능을 잘 활용할 수 있게 되었다. 마음 같아서는 더 높은 버전으로 변경하고 싶었지만, 권한으로 업그레이드 할 수 있는 부분은 1.8이 가능한 최대 높이였다.

